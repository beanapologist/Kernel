name: CI

on:
  push:
    branches: [main]
    paths:
      - '**.cpp'
      - '**.hpp'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main]
    paths:
      - '**.cpp'
      - '**.hpp'
      - '.github/workflows/ci.yml'

permissions:
  contents: read

jobs:
  # ── Lint ──────────────────────────────────────────────────────────────────
  lint:
    name: clang-format check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: sudo apt-get install -y clang-format

      - name: Check formatting
        run: |
          clang-format --dry-run --Werror \
            quantum_kernel_v2.cpp \
            qudit_kernel.cpp \
            test_pipeline_theorems.cpp \
            test_ipc.cpp \
            test_qudit_kernel.cpp \
            test_interrupt_nist.cpp \
            benchmark_nist_ir8356.cpp \
            ChiralNonlinearGate.hpp \
            LadderChiralSearch.hpp \
            LadderSearchBenchmark.hpp \
            ohm_coherence_duality.hpp \
            test_ohm_coherence.cpp \
            PalindromePrecession.hpp \
            test_palindrome_precession.cpp \
            KernelState.hpp \
            SpectralBridge.hpp \
            KernelPipeline.hpp \
            test_kernel_pipeline.cpp \
            test_coherent_search.cpp

  # ── Build & Test ─────────────────────────────────────────────────────────
  build-and-test:
    name: Build and run tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get install -y libssl-dev libeigen3-dev

      - name: Build test_pipeline_theorems
        run: g++ -std=c++17 -Wall -Wextra -O2 -o test_pipeline_theorems test_pipeline_theorems.cpp -lm

      - name: Run test_pipeline_theorems
        run: ./test_pipeline_theorems

      - name: Build test_ipc
        run: g++ -std=c++17 -Wall -Wextra -O2 -o test_ipc_bin test_ipc.cpp -lm

      - name: Run test_ipc
        run: ./test_ipc_bin

      - name: Build test_qudit_kernel
        run: g++ -std=c++17 -Wall -Wextra -O2 -o test_qudit_kernel test_qudit_kernel.cpp -lm

      - name: Run test_qudit_kernel
        run: ./test_qudit_kernel

      - name: Build test_interrupt_nist
        run: g++ -std=c++17 -Wall -Wextra -O2 -o test_interrupt_nist test_interrupt_nist.cpp -lm

      - name: Run test_interrupt_nist
        run: ./test_interrupt_nist

      - name: Build test_ohm_coherence
        run: g++ -std=c++17 -Wall -Wextra -O2 -o test_ohm_coherence test_ohm_coherence.cpp -lm

      - name: Run test_ohm_coherence
        run: ./test_ohm_coherence

      - name: Build test_palindrome_precession
        run: g++ -std=c++17 -Wall -Wextra -O2 -o test_palindrome_precession test_palindrome_precession.cpp -lm

      - name: Run test_palindrome_precession
        run: ./test_palindrome_precession

      - name: Build test_kernel_pipeline
        run: g++ -std=c++17 -Wall -Wextra -O2 -o test_kernel_pipeline test_kernel_pipeline.cpp -lm

      - name: Run test_kernel_pipeline
        run: ./test_kernel_pipeline

      - name: Build test_coherent_search
        run: g++ -std=c++17 -Wall -Wextra -O2 -o test_coherent_search test_coherent_search.cpp -lm

      - name: Run test_coherent_search
        run: ./test_coherent_search

  # ── Benchmarks ───────────────────────────────────────────────────────────
  benchmarks:
    name: Run benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get install -y libssl-dev libeigen3-dev

      - name: Build benchmark_nist_ir8356
        run: g++ -std=c++17 -Wall -Wextra -O2 -o benchmark_nist_ir8356 benchmark_nist_ir8356.cpp -lm

      - name: Run NIST IR 8356 benchmark
        run: ./benchmark_nist_ir8356

      - name: Build benchmark_pow_nonce_search (hybrid vs brute-force)
        run: g++ -std=c++17 -Wall -Wextra -O2 -o benchmark_pow_nonce_search benchmark_pow_nonce_search.cpp -lssl -lcrypto -lm

      - name: Run PoW nonce search benchmark
        run: ./benchmark_pow_nonce_search

  # ── Coverage ─────────────────────────────────────────────────────────────
  coverage:
    name: Code coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get install -y lcov

      - name: Build tests with coverage instrumentation
        run: |
          g++ -std=c++17 -O0 --coverage -o test_pipeline_theorems test_pipeline_theorems.cpp -lm
          g++ -std=c++17 -O0 --coverage -o test_ipc_bin             test_ipc.cpp             -lm
          g++ -std=c++17 -O0 --coverage -o test_qudit_kernel        test_qudit_kernel.cpp    -lm
          g++ -std=c++17 -O0 --coverage -o test_interrupt_nist      test_interrupt_nist.cpp  -lm
          g++ -std=c++17 -O0 --coverage -o test_ohm_coherence       test_ohm_coherence.cpp   -lm
          g++ -std=c++17 -O0 --coverage -o test_palindrome_precession test_palindrome_precession.cpp -lm
          g++ -std=c++17 -O0 --coverage -o test_kernel_pipeline     test_kernel_pipeline.cpp -lm
          g++ -std=c++17 -O0 --coverage -o test_coherent_search    test_coherent_search.cpp -lm

      - name: Run tests to collect coverage data
        run: |
          ./test_pipeline_theorems
          ./test_ipc_bin
          ./test_qudit_kernel
          ./test_interrupt_nist
          ./test_ohm_coherence
          ./test_palindrome_precession
          ./test_kernel_pipeline
          ./test_coherent_search

      - name: Generate lcov report
        run: |
          lcov --capture --directory . --output-file coverage.info --ignore-errors mismatch
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          lcov --list coverage.info

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.info
